var resultURL;
var curval = 0;
function showHide(){
	$("#fileUploadScan").slideToggle( "slow", function(){});
	/*$(".file-preview").slideToggle("slow",function(){});
	$(".file-input").slideToggle("slow",function(){});*/		
	startUpload(0);
}
function startUpload(val){	
	var fileInput = document.getElementById("fileInput");

	/*xhr.open("POST", "https://scan.metascan-online.com/v2/file", false);
	xhr.setRequestHeader("apikey","58ce3f1051aa149c179aa4a4e6fa7dc3",false);
	xhr.setRequestHeader("filename","blap",false);
	xhr.send(fileInput.files[0]);*/

	//console.log("Upload response: " + xhr.responseText);

	/*var result = JSON.parse(xhr.responseText);
	var resultURL = "https://scan.metascan-online.com/v2/file/"+result.data_id;	

	xhr.open("GET", resultURL, false);
	xhr.setRequestHeader("apikey","58ce3f1051aa149c179aa4a4e6fa7dc3",false);
	xhr.send();

	console.log("Scan result: " + xhr.responseText);*/
	console.log(fileInput.files[val].name);
	$.ajax( {
	    url: 'https://scan.metascan-online.com/v2/file',
	    type: 'POST',
	    data: fileInput.files[val],
	    processData: false,
	    beforeSend : function( xhr ) {
	        xhr.setRequestHeader("apikey","58ce3f1051aa149c179aa4a4e6fa7dc3",false);
			xhr.setRequestHeader("filename",fileInput.files[val].name,false);
	    },
	    success: function( response ) {
	        // response
	        console.log("Upload response: " + JSON.stringify(response));
	        $("#adduploads").find('tbody')
    			.append($('<tr>')
    				.append($('<div>')
		                .attr('class', 'alert alert-info')
		                .attr('role', 'alert')
		                .attr('id', response.data_id)
		                .css('font-weight','bold')
		                .text('Scanning '+fileInput.files[val].name+", Progress: 0%")
		            ).hide().fadeIn(200)
            	);
	        getReport(response);
	        
	    }
	} );
}

function getReport(response1){
	var fileInput = document.getElementById("fileInput");
	$.ajax( {
	    url: "https://scan.metascan-online.com/v2/file/"+response1.data_id,
	    type: 'GET',
	    beforeSend : function( xhr ) {
	        xhr.setRequestHeader("apikey","58ce3f1051aa149c179aa4a4e6fa7dc3",false);
	    },
	    success: function( response2 ) {
			console.log("Scan result: " + JSON.stringify(response2));
			// Try to get the result again in a little bit if it wasn't done scanning yet.
			if(response2.scan_results.progress_percentage!=100&&response2.file_info.file_type_description!="empty"){
				$("#"+response1.data_id).text($("#"+response1.data_id).text().split(":")[0]+": "+response2.scan_results.progress_percentage+"%");
				setTimeout(function(){getReport(response1)},1000);
			}
			// Go to the next file if we've got the result. (Can't upload in parallel on this API)
			else{
				$("#"+response1.data_id).text("Done "+$("#"+response1.data_id).text().split(",")[0]);
				$("#"+response1.data_id).removeClass("alert-info").addClass("alert-success").fadeIn('fast');
				if(curval+1<fileInput.files.length){
					curval++;
					startUpload(curval);
				}
			}
	    }
	} );
}