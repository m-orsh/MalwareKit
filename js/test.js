var resultURL;
var curval = 0;
var responseJSON;
var curTime = 0;
var curFileCount = 0;
var curInfectedCount = 0;
var timeElapsedInterval;

String.prototype.toHHMMSS = function () {
    var sec_num = parseInt(this, 10); // don't forget the second param
    var hours   = Math.floor(sec_num / 3600);
    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
    var seconds = sec_num - (hours * 3600) - (minutes * 60);

    if (hours   < 10) {hours   = "0"+hours;}
    if (minutes < 10) {minutes = "0"+minutes;}
    if (seconds < 10) {seconds = "0"+seconds;}
    var time    = hours+':'+minutes+':'+seconds;
    return time;
}

function showHide(){
	var fileInput = document.getElementById("fileInput");
	//Don't scan if there isn't anything to scan.
	if(fileInput.files[0]){
		timeElapsedInterval = setInterval(function () {
									$("#elapsedtime").text(String(curTime).toHHMMSS());
									curTime++;
								}, 1000);
		$("#fileUploadScan").slideToggle( "slow", function(){$("#totals").slideToggle( "slow", function(){});});
		startUpload(0);
	}
}

function startUpload(val){	
	var fileInput = document.getElementById("fileInput");

	console.log(fileInput.files[val].name);
	//we'll shorten the filename if it's huge
	var split = fileInput.files[val].name.split(".");
	var shortenfile = (fileInput.files[val].name.length>25)?(fileInput.files[val].name.substring(0,18)+"...."+split[split.length-1]):(fileInput.files[val].name);

    $("#adduploads").find('tbody')
		.append($('<tr>')
			.append($('<div>')
                .attr('class', 'alert alert-info')
                .attr('role', 'alert')
                //We can't uniquely identify each upload div yet, we'll change it after getting the reponse.
                .attr('id', 'givemeID')
                .css('font-weight','bold')
                .text('Uploading '+shortenfile)
            ).hide().fadeIn(200)
    	);
	$.ajax( {
	    url: 'https://scan.metascan-online.com/v2/file',
	    type: 'POST',
	    data: fileInput.files[val],
	    processData: false,
	    beforeSend : function( xhr ) {
	        xhr.setRequestHeader("apikey","58ce3f1051aa149c179aa4a4e6fa7dc3",false);
			xhr.setRequestHeader("filename",shortenfile,false);
	    },
	    success: function( response ) {
	        // response
	        console.log("Upload response: " + JSON.stringify(response));
	        getReport(response);
	        //Fix the ID here so it is unique
	        $("#givemeID").text('Scanning '+shortenfile+", 0%");
	        $("#givemeID").attr('id', response.data_id);
	    }
	} );
}

function getReport(response1){
	var fileInput = document.getElementById("fileInput");
	$.ajax( {
	    url: "https://scan.metascan-online.com/v2/file/"+response1.data_id,
	    type: 'GET',
	    beforeSend : function( xhr ) {
	        xhr.setRequestHeader("apikey","58ce3f1051aa149c179aa4a4e6fa7dc3",false);
	    },
	    success: function( response2 ) {
			console.log("Scan result: " + JSON.stringify(response2));
			// Try to get the result again in a little bit if it wasn't done scanning yet.
			if(response2.scan_results.progress_percentage!=100&&response2.file_info.file_type_description!="empty"){
				$("#"+response1.data_id).text($("#"+response1.data_id).text().split(",")[0]+", "+response2.scan_results.progress_percentage+"%");
				setTimeout(function(){getReport(response1)},1000);
			}
			// Go to the next file if we've got the result. (Can't upload in parallel on this API)
			else{
				if(response2.scan_results.scan_all_result_a=="Clean"){
					$("#"+response1.data_id).text("Done "+$("#"+response1.data_id).text().split(",")[0]);
					$("#"+response1.data_id).removeClass("alert-info").addClass("alert-success").fadeIn('fast');
					setTimeout(function(){$("#"+response1.data_id).slideToggle( "slow", function(){})},5000);	
				}
				else{
					$("#"+response1.data_id).text($("#"+response1.data_id).text().split(",")[0].split("g")[1] + " was " + response2.scan_results.scan_all_result_a);
					$("#"+response1.data_id).removeClass("alert-info").addClass("alert-danger").fadeIn('fast');
					$("#"+response1.data_id).append('</br>').append($('<center>').append($('<button>')
							.attr('class','btn btn-danger')
							.attr('data-toggle','modal')
							.attr('data-target','#myModal')
							.css('margin-top','10px')
							.click(function() {JSONtohtml(response2)})
							.text('View Report')
							.hide().fadeIn(200)
						)
					);
					if(response2.scan_results.scan_all_result_a=="Infected"){
						curInfectedCount++;
						$("#totalinfected").text(curInfectedCount);
					}
				}

				curFileCount++;
				$("#totalscanned").text(curFileCount);

				if(curval+1<fileInput.files.length){
					curval++;
					startUpload(curval);
				}
				else{
					//Do this when we're done
					$("#donetext").fadeIn("slow",function(){});
					window.clearTimeout(timeElapsedInterval);
				}
			}
	    }
	} );
}

function JSONtohtml(json){
    	//Convert to report from JSON response
    	var result = json;
        $("#maindetsreport")
          .append($('<li>')
            .attr('class','list-group-item')
            .text("Scan Result: "+result.scan_results.scan_all_result_a)
          )
          .append($('<li>')
            .attr('class','list-group-item')
            .text("Total Scan Time: "+result.scan_results.total_time)
          )
          .append($('<li>')
            .attr('class','list-group-item')
            .text("Scanned with "+result.scan_results.total_avs+" different antivirus software.")
          );
        $("#filedetsreport")
          .append($('<li>')
            .attr('class','list-group-item')
            .text("Filename: "+result.file_info.display_name)
          )
          .append($('<li>')
            .attr('class','list-group-item')
            .text("File Size: "+result.file_info.file_size/1000 + "kb")
          )
          .append($('<li>')
            .attr('class','list-group-item')
            .text("File Type: "+result.file_info.file_type_description)
          )
          .append($('<li>')
            .attr('class','list-group-item')
            .text("File Extension: "+result.file_info.file_type_extension)
          );


        var scan_details = result.scan_results.scan_details;
        for (var key in scan_details) {
          if (scan_details.hasOwnProperty(key)) {
              $("#scandetsPanelBody")
                .append($('<div>')
                  .attr('class','panel panel-default')
                  .append($('<div>')
                    .attr('class','panel-heading')
                    .append($('<div>')
                      .attr('class','panel-title')
                      .append($('<a>')
                        .attr('id',key)
                        .attr('data-toggle','collapse')
                        .attr('href','#collapse'+key)
                        .attr('class','panel-title')
                        .text(key)
                      )
                    )
                  )
                .append($('<div>')
                  .attr('id','collapse'+key)
                  .attr('class','panel-collapse collapse in')
                    .append($('<div>')
                      .attr('id',key+'PanelBody')
                      .attr('class','panel-body')
                      .append($('<li>')
                        .text("Infection Detected: "+((scan_details[key].scan_result_i==1)?"Yes":"No"))
                      )
                      .append($('<li>')
                        .text("Threat Found: "+scan_details[key].threat_found)
                      )
                      .append($('<li>')
                        .text("Scan Time: "+scan_details[key].scan_time)
                      )
                    )
                )

              )
            }
        }

        //on closing this modal dialog, we remove what we've added.
        $('#myModal').on('hidden.bs.modal', function () {
    		$("#maindetsreport").empty();
        	$("#filedetsreport").empty();
            $("#scandetsPanelBody").empty();
        })

    }